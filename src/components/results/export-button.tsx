"use client";

import { Download } from "lucide-react";
import { Button } from "@/components/ui/button";
import type { AnalysisResult } from "@/lib/types";
import { CATEGORY_MAP } from "@/lib/data";

interface ExportButtonProps {
  result: AnalysisResult;
}

function generateMarkdown(result: AnalysisResult): string {
  const lines: string[] = [];

  lines.push("# DevCheck Analysis Report");
  lines.push("");
  lines.push(`**Overall Score:** ${result.overallScore}/100 (Grade ${result.grade})`);
  lines.push(`**Verdict:** ${result.verdictText}`);
  lines.push(`**Generated:** ${new Date(result.generatedAt).toLocaleString()}`);
  lines.push("");

  if (result.hasCritical) {
    lines.push("> **Warning:** Critical issues were detected. Score capped at 60.");
    lines.push("");
  }

  lines.push("## Category Results");
  lines.push("");

  for (const cat of result.categories) {
    const category = CATEGORY_MAP[cat.categoryId];
    if (!category) continue;

    const emoji = cat.percentage >= 85 ? "+" : cat.percentage >= 65 ? "!" : "-";
    lines.push(`### ${category.name} — ${cat.percentage}% [${emoji}]`);
    lines.push("");

    if (cat.issues.length === 0) {
      lines.push("No issues found.");
    } else {
      for (const issue of cat.issues) {
        lines.push(`- **[${issue.severity.toUpperCase()}]** ${issue.title}`);
        lines.push(`  ${issue.description}`);
        lines.push(`  *Fix:* ${issue.recommendation}`);
        lines.push(`  *Guideline:* ${issue.guidelineSection} — ${issue.guidelineUrl}`);
      }
    }
    lines.push("");
  }

  lines.push("---");
  lines.push("*Generated by DevCheck — App Store Rejection Prevention Tool*");

  return lines.join("\n");
}

export function ExportButton({ result }: ExportButtonProps) {
  const handleExport = () => {
    const markdown = generateMarkdown(result);
    const blob = new Blob([markdown], { type: "text/markdown" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `devcheck-report-${new Date().toISOString().split("T")[0]}.md`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <Button
      variant="outline"
      size="sm"
      onClick={handleExport}
      className="border-zinc-700 text-zinc-300 hover:bg-zinc-800"
    >
      <Download className="mr-2 h-4 w-4" />
      Export Report
    </Button>
  );
}
